#pragma once
#include <Windows.h>
#include <lua.h>
#include "Memory.h"

using namespace Memory;

constexpr const wchar_t* exeName = L"robloxplayerbeta.exe";
extern int* luaState;

#define rlua_getglobal(L,s)     rlua_getfield(L, LUA_GLOBALSINDEX, (s))
#define rlua_setglobal(L,s)     rlua_setfield(L, LUA_GLOBALSINDEX, (s))
#define rlua_pop(L, n)          rlua_settop(L, -(n)-1)

#define getfieldcc __stdcall // checked
typedef void(getfieldcc* prlua_getfield) (const char* k); // 55 8B EC 83 EC 10 53 56 57 8B F1 52 56 E8 ?? ?? ?? ?? 8B 4D 08 83 C4 08 8B D1 8B F8 8D 5A 01 90 8A 02 42 84 C0 75 F9 2B D3 52 51 56 E8 ?? ?? ?? ?? 6A 01
constexpr const char* sigrlua_getfield = "\x55\x8B\xEC\x83\xEC\x10\x53\x56\x57\x8B\xF1\x52\x56\xE8????\x8B\x4D\x08\x83\xC4\x08\x8B\xD1\x8B\xF8\x8D\x5A\x01\x90\x8A\x02\x42\x84\xC0\x75\xF9\x2B\xD3\x52\x51\x56\xE8????\x6A\x01";
extern prlua_getfield _rlua_getfield;

#define setfieldcc __cdecl // checked
typedef void(setfieldcc* prlua_setfield) (int* L, int idx, const char* k); //
constexpr const char* sigrlua_setfield = "\x55\x8B\xEC\x83\xEC\x10\x53\x56\x8B\x75\x08\x57\xFF\x75\x0C\x56\xE8????\x8B\x55\x10\x83\xC4\x08\x8B\xCA\x8B\xF8\x8D\x59\x01\x8A\x01\x41\x84\xC0\x75\xF9\x2B\xCB\x51\x52\x56\xE8????\x89\x45\xF0";
extern prlua_setfield rlua_setfield;

#define pushnilcc __cdecl // checked
typedef void(pushnilcc* prlua_pushnil) (int* L); // 55 8B EC 8B 4D 08 8B 41 10 C7 40 08
constexpr const char* sigrlua_pushnil = "\x55\x8B\xEC\x8B\x4D\x08\x8B\x41\x10\xC7\x40\x08";
extern prlua_pushnil rlua_pushnil;

#define pushvaluecc __stdcall // checked
typedef void(pushvaluecc* prlua_pushvalue) (int* L, int idx); // 55 8B EC 56 FF 75 0C 8B 75 08 56 E8 F0 9A FF FF 8B 56 10
constexpr const char* sigrlua_pushvalue = "\x55\x8B\xEC\x56\xFF\x75\x0C\x8B\x75\x08\x56\xE8\xF0\x9A\xFF\xFF\x8B\x56\x10";
extern prlua_pushvalue rlua_pushvalue;

#define pushnumbercc __cdecl // checked
typedef void(pushnumbercc* prlua_pushnumber) (int* L, double n); // 55 8B EC 8B 55 08 8B 45 0C 8B 4A 10
constexpr const char* sigrlua_pushnumber = "\x55\x8B\xEC\x8B\x55\x08\x8B\x45\x0C\x8B\x4A\x10";
extern prlua_pushnumber rlua_pushnumber;

#define pushbooleancc __cdecl // checked
typedef void(pushbooleancc* prlua_pushboolean) (int* L, int b); // 55 8B EC 8B 55 08 33 C0 39 45 0C
constexpr const char* sigrlua_pushboolean = "\x55\x8B\xEC\x8B\x55\x08\x33\xC0\x39\x45\x0C";
extern prlua_pushboolean rlua_pushboolean;

#define pushlstringcc __cdecl // checked
typedef const char* (pushlstringcc* prlua_pushlstring) (int* L, const char* s, size_t l); // 55 8B EC 56 57 8B 7D 08 8B C7 8B 4F 18 8D 57 18 2B C1 2B D1 8B 40 68 3B 42 4C 72 09 57 E8 ?? ?? ?? ?? 83 C4 04 FF 75 10 8B 77 10 FF 75 0C 57 E8 ?? ?? ?? ?? 89 06 C7 46 08 04 00 00 00
constexpr const char* sigrlua_pushlstring = "\x55\x8B\xEC\x56\x57\x8B\x7D\x08\x8B\xC7\x8B\x4F\x18\x8D\x57\x18\x2B\xC1\x2B\xD1\x8B\x40\x68\x3B\x42\x4C\x72\x09\x57\xE8????\x83\xC4\x04\xFF\x75\x10\x8B\x77\x10\xFF\x75\x0C\x57\xE8????\x89\x06\xC7\x46\x08\x04\x00\x00\x00";
extern prlua_pushlstring rlua_pushlstring;

#define callcc __cdecl // checked
typedef void(callcc* prlua_call) (int* L, int nargs, int nresults); // 55 8B EC 8B 4D 0C 57 8B 7D 08 FF 75 10 8D 49 01 C1 E1 04 8B 47 10 2B C1
constexpr const char* sigrlua_call = "\x55\x8B\xEC\x8B\x4D\x0C\x57\x8B\x7D\x08\xFF\x75\x10\x8D\x49\x01\xC1\xE1\x04\x8B\x47\x10\x2B\xC1";
extern prlua_call rlua_call;

#define pcallcc __cdecl // checked
typedef int (pcallcc* prlua_pcall) (int* L, int nargs, int nresults, int errfunc); // 55 8B EC 8B 45 14 83 EC 08 53 56 57 8B 7D 08 85 C0
constexpr const char* sigrlua_pcall = "\x55\x8B\xEC\x8B\x45\x14\x83\xEC\x08\x53\x56\x57\x8B\x7D\x08\x85\xC0";
extern prlua_pcall rlua_pcall;

#define gettopcc __cdecl // checked
typedef int(gettopcc* prlua_gettop) (int* L); // 55 8B EC 8B 4D 08 8B 41 10 2B 41 14
constexpr const char* sigrlua_gettop = "\x55\x8B\xEC\x8B\x4D\x08\x8B\x41\x10\x2B\x41\x14";
extern prlua_gettop rlua_gettop;

#define settopcc __cdecl // checked
typedef void(settopcc* prlua_settop) (); // 55 8B EC 56 8B F2
constexpr const char* sigrlua_settop = "\x55\x8B\xEC\x56\x8B\xF2";
extern prlua_settop _rlua_settop;

inline void rlua_settop(int* L, int idx)
{
	__asm {
		mov edx, idx
		mov ecx, L
	}

	_rlua_settop();

	return;
}

inline void rlua_getfield(int* L, int idx, const char* k)
{
	__asm {
		mov ecx, L
		mov edx, idx
	}

	_rlua_getfield(k);

	return;
}

inline void rlua_pushstring(int* L, std::string str)
{
	rlua_pushlstring(L, str.c_str(), str.length());

	return;
}

namespace RFunc {
	bool Initialize();
}
